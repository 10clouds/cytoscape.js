
/* jquery.cytoscapeweb.layout.springy.min.js */

/**
 * This file is part of Cytoscape Web snapshot-2012.02.14-14.30.18.
 * 
 * Cytoscape Web is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 * 
 * Cytoscape Web is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License along with
 * Cytoscape Web. If not, see <http://www.gnu.org/licenses/>.
 */
 
$(function(){var b={maxSimulationTime:1000,ungrabifyWhileSimulating:true,fit:true,random:false};function d(){$.cytoscapeweb("debug","Creating Springy layout with options")}function a(j){if(j!=null&&typeof j==typeof function(){}){j()}}d.prototype.run=function(D){var q=$.extend(true,{},b,D);$.cytoscapeweb("debug","Running Springy layout with options (%o)",q);var p=D.cy;var y=p.nodes();var o=p.edges();var u=p.container();var m=new h();y.each(function(G,H){H._private.fd=m.newNode({element:H})});o.each(function(G,H){fdSrc=H.source()._private.fd;
fdTgt=H.target()._private.fd;H._private.fd=m.newEdge(fdSrc,fdTgt,{element:H})});var C=new i.ForceDirected(m,400,400,0.5);var n=C.getBoundingBox();var t={bottomleft:new Vector(-2,-2),topright:new Vector(2,2)};var B=function(H){var G=n.topright.subtract(n.bottomleft);var J=H.subtract(n.bottomleft).divide(G.x).x*u.width();var I=H.subtract(n.bottomleft).divide(G.y).y*u.height();return new Vector(J,I)};var k=function(J){var I=n.topright.subtract(n.bottomleft);var H=(J.x/u.width())*I.x+n.bottomleft.x;var G=(J.y/u.height())*I.y+n.bottomleft.y;
return new Vector(H,G)};var j=p.collection();var x=p.nodes().size();var E=1;var F=new c(10,C,function w(){},function s(G,I,H){},function A(I,J){var G=B(J);var H=I.data.element;window.p=J;window.n=I;if(!H.locked()){H._private.position={x:G.x,y:G.y};j=j.add(H)}else{v(H)}if(E==x){p.trigger("layoutready");a(D.ready)}E++});y.each(function(G,H){if(!q.random){v(H)}});setInterval(function(){if(j.size()>0){j.rtrigger("position");j=p.collection()}},50);y.bind("drag",function(){v(this)});function v(H){var K=H._private.fd.id;
var I=F.layout.nodePoints[K].p;var J=H._private.position;var G=(J.x!=null&&J.y!=null)?k(H._private.position):{x:Math.random()*4-2,y:Math.random()*4-2};I.x=G.x;I.y=G.y}var l=y.filter(":grabbable");function r(){if(q.ungrabifyWhileSimulating){l.ungrabify()}F.start()}function z(G){m.filterNodes(function(){return false});setTimeout(function(){if(q.ungrabifyWhileSimulating){l.grabify()}G()},100)}r();setTimeout(function(){z(function(){if(q.fit){p.fit()}p.trigger("layoutstop");a(D.stop)})},q.maxSimulationTime)
};$.cytoscapeweb("layout","springy",d);var h=function(){this.nodeSet={};this.nodes=[];this.edges=[];this.adjacency={};this.nextNodeId=0;this.nextEdgeId=0;this.eventListeners=[]};var g=function(k,j){this.id=k;this.data=typeof(j)!=="undefined"?j:{}};var e=function(m,k,l,j){this.id=m;this.source=k;this.target=l;this.data=typeof(j)!=="undefined"?j:{}};h.prototype.addNode=function(j){if(typeof(this.nodeSet[j.id])==="undefined"){this.nodes.push(j)}this.nodeSet[j.id]=j;this.notify();return j};h.prototype.addEdge=function(k){var j=false;
this.edges.forEach(function(l){if(k.id===l.id){j=true}});if(!j){this.edges.push(k)}if(typeof(this.adjacency[k.source.id])==="undefined"){this.adjacency[k.source.id]={}}if(typeof(this.adjacency[k.source.id][k.target.id])==="undefined"){this.adjacency[k.source.id][k.target.id]=[]}j=false;this.adjacency[k.source.id][k.target.id].forEach(function(l){if(k.id===l.id){j=true}});if(!j){this.adjacency[k.source.id][k.target.id].push(k)}this.notify();return k};h.prototype.newNode=function(k){var j=new g(this.nextNodeId++,k);
this.addNode(j);return j};h.prototype.newEdge=function(l,m,k){var j=new e(this.nextEdgeId++,l,m,k);this.addEdge(j);return j};h.prototype.getEdges=function(k,j){if(typeof(this.adjacency[k.id])!=="undefined"&&typeof(this.adjacency[k.id][j.id])!=="undefined"){return this.adjacency[k.id][j.id]}return[]};h.prototype.removeNode=function(k){if(typeof(this.nodeSet[k.id])!=="undefined"){delete this.nodeSet[k.id]}for(var j=this.nodes.length-1;j>=0;j--){if(this.nodes[j].id===k.id){this.nodes.splice(j,1)}}this.detachNode(k)
};h.prototype.detachNode=function(j){var k=this.edges.slice();k.forEach(function(l){if(l.source.id===j.id||l.target.id===j.id){this.removeEdge(l)}},this);this.notify()};h.prototype.removeEdge=function(o){for(var n=this.edges.length-1;n>=0;n--){if(this.edges[n].id===o.id){this.edges.splice(n,1)}}for(var k in this.adjacency){for(var p in this.adjacency[k]){var l=this.adjacency[k][p];for(var m=l.length-1;m>=0;m--){if(this.adjacency[k][p][m].id===o.id){this.adjacency[k][p].splice(m,1)}}}}this.notify()
};h.prototype.merge=function(k){var j=[];k.nodes.forEach(function(l){j.push(this.addNode(new g(l.id,l.data)))},this);k.edges.forEach(function(m){var p=j[m.from];var o=j[m.to];var n=(m.directed)?(n=m.type+"-"+p.id+"-"+o.id):(p.id<o.id)?m.type+"-"+p.id+"-"+o.id:m.type+"-"+o.id+"-"+p.id;var l=this.addEdge(new e(n,p,o,m.data));l.data.type=m.type},this)};h.prototype.filterNodes=function(j){var k=this.nodes.slice();k.forEach(function(l){if(!j(l)){this.removeNode(l)}},this)};h.prototype.filterEdges=function(j){var k=this.edges.slice();
k.forEach(function(l){if(!j(l)){this.removeEdge(l)}},this)};h.prototype.addGraphListener=function(j){this.eventListeners.push(j)};h.prototype.notify=function(){this.eventListeners.forEach(function(j){j.graphChanged()})};var i={};i.ForceDirected=function(m,j,k,l){this.graph=m;this.stiffness=j;this.repulsion=k;this.damping=l;this.nodePoints={};this.edgeSprings={}};i.ForceDirected.prototype.point=function(k){if(typeof(this.nodePoints[k.id])==="undefined"){var j=typeof(k.data.mass)!=="undefined"?k.data.mass:1;
this.nodePoints[k.id]=new i.ForceDirected.Point(Vector.random(),j)}return this.nodePoints[k.id]};i.ForceDirected.prototype.spring=function(k){if(typeof(this.edgeSprings[k.id])==="undefined"){var j=typeof(k.data.length)!=="undefined"?k.data.length:1;var l=false;var n=this.graph.getEdges(k.source,k.target);n.forEach(function(o){if(l===false&&typeof(this.edgeSprings[o.id])!=="undefined"){l=this.edgeSprings[o.id]}},this);if(l!==false){return new i.ForceDirected.Spring(l.point1,l.point2,0,0)}var m=this.graph.getEdges(k.target,k.source);
n.forEach(function(o){if(l===false&&typeof(this.edgeSprings[o.id])!=="undefined"){l=this.edgeSprings[o.id]}},this);if(l!==false){return new i.ForceDirected.Spring(l.point2,l.point1,0,0)}this.edgeSprings[k.id]=new i.ForceDirected.Spring(this.point(k.source),this.point(k.target),j,this.stiffness)}return this.edgeSprings[k.id]};i.ForceDirected.prototype.eachNode=function(k){var j=this;this.graph.nodes.forEach(function(l){k.call(j,l,j.point(l))})};i.ForceDirected.prototype.eachEdge=function(k){var j=this;
this.graph.edges.forEach(function(l){k.call(j,l,j.spring(l))})};i.ForceDirected.prototype.eachSpring=function(k){var j=this;this.graph.edges.forEach(function(l){k.call(j,j.spring(l))})};i.ForceDirected.prototype.applyCoulombsLaw=function(){this.eachNode(function(k,j){this.eachNode(function(m,l){if(j!==l){var o=j.p.subtract(l.p);var p=o.magnitude()+0.1;var n=o.normalise();j.applyForce(n.multiply(this.repulsion).divide(p*p*0.5));l.applyForce(n.multiply(this.repulsion).divide(p*p*-0.5))}})})};i.ForceDirected.prototype.applyHookesLaw=function(){this.eachSpring(function(j){var m=j.point2.p.subtract(j.point1.p);
var k=j.length-m.magnitude();var l=m.normalise();j.point1.applyForce(l.multiply(j.k*k*-0.5));j.point2.applyForce(l.multiply(j.k*k*0.5))})};i.ForceDirected.prototype.attractToCentre=function(){this.eachNode(function(k,j){var l=j.p.multiply(-1);j.applyForce(l.multiply(this.repulsion/50))})};i.ForceDirected.prototype.updateVelocity=function(j){this.eachNode(function(l,k){k.v=k.v.add(k.a.multiply(j)).multiply(this.damping);k.a=new Vector(0,0)})};i.ForceDirected.prototype.updatePosition=function(j){this.eachNode(function(l,k){k.p=k.p.add(k.v.multiply(j))
})};i.ForceDirected.prototype.totalEnergy=function(j){var k=0;this.eachNode(function(m,l){var n=l.v.magnitude();k+=0.5*l.m*n*n});return k};var f=function(j,k){return function(){return j.apply(k,arguments)}};i.requestAnimationFrame=f(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(k,j){window.setTimeout(k,10)},window);i.ForceDirected.prototype.start=function(k,m,j){var l=this;
if(this._started){return}this._started=true;i.requestAnimationFrame(function n(){l.applyCoulombsLaw();l.applyHookesLaw();l.attractToCentre();l.updateVelocity(0.03);l.updatePosition(0.03);if(typeof(m)!=="undefined"){m()}if(l.totalEnergy()<0.01){l._started=false;if(typeof(j)!=="undefined"){j()}}else{i.requestAnimationFrame(n)}})};i.ForceDirected.prototype.nearest=function(l){var k={node:null,point:null,distance:null};var j=this;this.graph.nodes.forEach(function(p){var m=j.point(p);var o=m.p.subtract(l).magnitude();
if(k.distance===null||o<k.distance){k={node:p,point:m,distance:o}}});return k};i.ForceDirected.prototype.getBoundingBox=function(){var j=new Vector(-2,-2);var l=new Vector(2,2);this.eachNode(function(o,m){if(m.p.x<j.x){j.x=m.p.x}if(m.p.y<j.y){j.y=m.p.y}if(m.p.x>l.x){l.x=m.p.x}if(m.p.y>l.y){l.y=m.p.y}});var k=l.subtract(j).multiply(0.07);return{bottomleft:j.subtract(k),topright:l.add(k)}};Vector=function(j,k){this.x=j;this.y=k};Vector.random=function(){return new Vector(10*(Math.random()-0.5),10*(Math.random()-0.5))
};Vector.prototype.add=function(j){return new Vector(this.x+j.x,this.y+j.y)};Vector.prototype.subtract=function(j){return new Vector(this.x-j.x,this.y-j.y)};Vector.prototype.multiply=function(j){return new Vector(this.x*j,this.y*j)};Vector.prototype.divide=function(j){return new Vector((this.x/j)||0,(this.y/j)||0)};Vector.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector.prototype.normal=function(){return new Vector(-this.y,this.x)};Vector.prototype.normalise=function(){return this.divide(this.magnitude())
};i.ForceDirected.Point=function(j,k){this.p=j;this.m=k;this.v=new Vector(0,0);this.a=new Vector(0,0)};i.ForceDirected.Point.prototype.applyForce=function(j){this.a=this.a.add(j.divide(this.m))};i.ForceDirected.Spring=function(m,l,n,j){this.point1=m;this.point2=l;this.length=n;this.k=j};function c(k,n,j,m,l){this.interval=k;this.layout=n;this.clear=j;this.drawEdge=m;this.drawNode=l;this.layout.graph.addGraphListener(this)}c.prototype.graphChanged=function(j){this.start()};c.prototype.start=function(){var j=this;
this.layout.start(50,function k(){j.clear();j.layout.eachEdge(function(m,l){j.drawEdge(m,l.point1.p,l.point2.p)});j.layout.eachNode(function(m,l){j.drawNode(m,l.p)})})}});